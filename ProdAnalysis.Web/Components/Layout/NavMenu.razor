@implements IDisposable
@using System.Threading
@using ProdAnalysis.Application.Dtos.Deviations
@using ProdAnalysis.Application.Services.Interfaces
@using ProdAnalysis.Domain.Enums
@inject CurrentUserService CurrentUser
@inject IDeviationEventService Deviations

<div style="display:flex; flex-direction:column; gap:10px;">
    <NavLink href="/" Match="NavLinkMatch.All" style="text-decoration:none; font-weight:700;">Главная</NavLink>
    <NavLink href="/auth/user" style="text-decoration:none;">Пользователь</NavLink>

    @if (CurrentUser.IsSet)
    {
        <div style="margin-top:10px; font-weight:700;">Смены</div>
        <NavLink href="/shifts" style="text-decoration:none;">Группы смен (multi)</NavLink>
        <NavLink href="/shifts/compact" style="text-decoration:none;">Группы смен (compact)</NavLink>
        <NavLink href="/production-days" style="text-decoration:none;">Список смен</NavLink>

        @if (CurrentUser.Role == UserRole.Operator || CurrentUser.Role == UserRole.Admin)
        {
            <NavLink href="/production-days/create" style="text-decoration:none;">Создать смену</NavLink>
        }

        <div style="margin-top:10px; font-weight:700;">Отчёты</div>
        <NavLink href="/reports/summary" style="text-decoration:none;">Сводка (план/факт)</NavLink>
        <NavLink href="/reports/pareto" style="text-decoration:none;">Pareto (простои)</NavLink>

        @if (CanSeeDeviations)
        {
            <div style="margin-top:10px; font-weight:700;">Отклонения</div>

            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <NavLink href="/deviations" style="text-decoration:none;">Отклонения:</NavLink>

                @if (!string.IsNullOrWhiteSpace(DeviationError))
                {
                    <span style="padding:2px 8px; border:1px solid #b00; border-radius:999px; color:#b00; font-size:12px;">!</span>
                }
                else
                {
                    <span style="display:inline-flex; gap:6px; align-items:center;">
                        <span style="padding:2px 8px; border:1px solid #777; border-radius:999px; color:#333; font-size:12px;">
                            @ActiveDeviationCount
                        </span>
                        <span style="padding:2px 8px; border:1px solid #b00; border-radius:999px; color:#b00; font-weight:700; font-size:12px;">
                            L2: @L2Count
                        </span>
                    </span>
                }
            </div>
        }

        @if (CurrentUser.Role == UserRole.Admin)
        {
            <div style="margin-top:10px; font-weight:700;">Администрирование</div>
            <NavLink href="/admin/workcenters" style="text-decoration:none;">WorkCenters</NavLink>
            <NavLink href="/admin/products" style="text-decoration:none;">Products</NavLink>
        }
    }
    else
    {
        <div style="margin-top:10px; color:#666;">Сначала выбери пользователя</div>
    }
</div>

@code {
    private int ActiveDeviationCount { get; set; }
    private int L2Count { get; set; }
    private string? DeviationError { get; set; }

    private Timer? _timer;
    private int _tickInProgress;

    private bool CanSeeDeviations =>
        CurrentUser.IsSet &&
        (CurrentUser.Role == UserRole.Master || CurrentUser.Role == UserRole.Manager || CurrentUser.Role == UserRole.Admin);

    protected override void OnInitialized()
    {
        CurrentUser.Changed += OnChanged;
        _ = InvokeAsync(async () =>
        {
            await RefreshCountsAsync();
            EnsureTimer();
            StateHasChanged();
        });
    }

    private void OnChanged()
    {
        _ = InvokeAsync(async () =>
        {
            await RefreshCountsAsync();
            EnsureTimer();
            StateHasChanged();
        });
    }

    private void EnsureTimer()
    {
        if (!CanSeeDeviations)
        {
            StopTimer();
            ActiveDeviationCount = 0;
            L2Count = 0;
            DeviationError = null;
            return;
        }

        if (_timer != null)
            return;

        _timer = new Timer(_ =>
        {
            _ = InvokeAsync(async () =>
            {
                if (!CanSeeDeviations)
                    return;

                if (Interlocked.Exchange(ref _tickInProgress, 1) == 1)
                    return;

                try
                {
                    await RefreshCountsAsync();
                    StateHasChanged();
                }
                finally
                {
                    Interlocked.Exchange(ref _tickInProgress, 0);
                }
            });
        }, null, TimeSpan.FromSeconds(20), TimeSpan.FromSeconds(20));
    }

    private void StopTimer()
    {
        var t = _timer;
        _timer = null;
        if (t != null)
            t.Dispose();
        Interlocked.Exchange(ref _tickInProgress, 0);
    }

    private async Task RefreshCountsAsync()
    {
        DeviationError = null;

        if (!CanSeeDeviations)
        {
            ActiveDeviationCount = 0;
            L2Count = 0;
            return;
        }

        try
        {
            var list = (await Deviations.ListAsync(null, null, false)).ToList();

            ActiveDeviationCount = list.Count(x => x.Status != DeviationEventStatus.Closed);
            L2Count = list.Count(x => x.Status == DeviationEventStatus.Open && x.CurrentEscalationLevel >= 2);
        }
        catch (Exception ex)
        {
            ActiveDeviationCount = 0;
            L2Count = 0;
            DeviationError = ex.Message;
        }
    }

    public void Dispose()
    {
        CurrentUser.Changed -= OnChanged;
        StopTimer();
    }
}
