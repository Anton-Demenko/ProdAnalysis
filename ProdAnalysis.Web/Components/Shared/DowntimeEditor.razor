@using ProdAnalysis.Application.Dtos.Downtime
@using ProdAnalysis.Application.Services.Interfaces
@using ProdAnalysis.Web.Services

@inject IDowntimeService DowntimeService
@inject CurrentUserService CurrentUser

<div style="padding:12px; border:1px solid #ddd; border-radius:8px; background:#fafafa;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px;">
        <div style="font-weight:700;">Downtimes</div>
        <div style="display:flex; gap:10px; align-items:center;">
            <div style="font-weight:700;">Total: @TotalMinutes / 60</div>
            <button type="button" @onclick="Close" style="padding:6px 10px; border:1px solid #aaa; border-radius:6px; background:#fff;">
                Close
            </button>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Error))
    {
        <div style="padding:10px; border:1px solid #c33; border-radius:8px; margin-bottom:10px;">
            @Error
        </div>
    }

    @if (IsLoading)
    {
        <div>Loading...</div>
    }
    else
    {
        <div style="overflow:auto; border:1px solid #e5e5e5; border-radius:8px; background:#fff;">
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="background:#f6f6f6;">
                        <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Reason</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid #ddd; width:140px;">Minutes</th>
                        <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Comment</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var e in Entries)
                    {
                        <tr>
                            <td style="padding:10px; border-bottom:1px solid #eee;">
                                <div style="font-weight:700;">@e.Name</div>
                                <div style="color:#666;">@e.Code</div>
                            </td>
                            <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">
                                <InputNumber TValue="int" @bind-Value="e.Minutes" style="width:90px; padding:6px 8px; border:1px solid #aaa; border-radius:6px; text-align:right;" />
                            </td>
                            <td style="padding:10px; border-bottom:1px solid #eee;">
                                <input type="text" @bind="e.Comment" style="width:100%; min-width:240px; padding:6px 8px; border:1px solid #aaa; border-radius:6px;" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button type="button" @onclick="Save" style="padding:8px 12px; border:1px solid #333; border-radius:8px; background:#fff;">
                Save
            </button>
            <button type="button" @onclick="Reload" style="padding:8px 12px; border:1px solid #aaa; border-radius:8px; background:#fff;">
                Reset
            </button>
        </div>
    }
</div>

@code {
    [Parameter] public Guid HourlyRecordId { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }
    [Parameter] public EventCallback OnClosed { get; set; }

    private bool IsLoading { get; set; } = true;
    private string? Error { get; set; }

    private sealed class Entry
    {
        public Guid ReasonId { get; set; }
        public string Code { get; set; } = "";
        public string Name { get; set; } = "";
        public int Minutes { get; set; }
        public string? Comment { get; set; }
    }

    private List<Entry> Entries { get; set; } = new();

    private int TotalMinutes => Entries.Sum(x => x.Minutes);

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
    }

    private async Task Reload()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        Error = null;
        IsLoading = true;

        try
        {
            if (!CurrentUser.IsSet)
                throw new InvalidOperationException("User not selected.");

            var reasons = await DowntimeService.GetReasonsAsync();
            var existing = await DowntimeService.GetHourlyDowntimesAsync(HourlyRecordId);

            var map = existing.ToDictionary(x => x.DowntimeReasonId, x => x);

            Entries = reasons.Select(r =>
            {
                map.TryGetValue(r.Id, out var ex);
                return new Entry
                {
                    ReasonId = r.Id,
                    Code = r.Code,
                    Name = r.Name,
                    Minutes = ex?.Minutes ?? 0,
                    Comment = ex?.Comment
                };
            }).ToList();
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task Save()
    {
        Error = null;

        try
        {
            if (!CurrentUser.IsSet)
                throw new InvalidOperationException("User not selected.");

            foreach (var e in Entries)
            {
                if (e.Minutes < 0 || e.Minutes > 60)
                    throw new InvalidOperationException("Minutes must be in range 0..60.");
            }

            if (TotalMinutes > 60)
                throw new InvalidOperationException("Total minutes per hour cannot exceed 60.");

            foreach (var e in Entries)
            {
                await DowntimeService.UpsertHourlyDowntimeAsync(
                    new UpsertHourlyDowntimeRequestDto(HourlyRecordId, e.ReasonId, e.Minutes, e.Comment),
                    CurrentUser.UserId!.Value
                );
            }

            await OnSaved.InvokeAsync();
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
    }

    private async Task Close()
    {
        await OnClosed.InvokeAsync();
    }
}