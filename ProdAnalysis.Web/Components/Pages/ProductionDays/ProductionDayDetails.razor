@page "/production-days/{Id:guid}"
@inject IProductionDayService ProductionDays
@inject CurrentUserService CurrentUser
@inject NavigationManager Nav

<h3>Смена</h3>

@if (!CurrentUser.IsSet)
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        Выбери пользователя.
        <button type="button" style="margin-left:10px; padding:6px 10px; border:1px solid #333; border-radius:6px; background:#fff;" @onclick="GoLogin">Перейти</button>
    </div>
}
else if (!string.IsNullOrWhiteSpace(Error))
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        @Error
    </div>
}
else if (Details == null)
{
    <div>Загрузка...</div>
}
else
{
    <div style="display:flex; flex-wrap:wrap; gap:14px; margin-bottom:14px;">
        <div style="padding:10px 12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700;">Дата</div>
            <div>@Details.Date.ToString("yyyy-MM-dd")</div>
        </div>
        <div style="padding:10px 12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700;">Смена</div>
            <div>@Details.ShiftStart.ToString("HH:mm") - @Details.ShiftEnd.ToString("HH:mm")</div>
        </div>
        <div style="padding:10px 12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700;">WorkCenter</div>
            <div>@Details.WorkCenterName</div>
        </div>
        <div style="padding:10px 12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700;">Product</div>
            <div>@Details.ProductName</div>
        </div>
        <div style="padding:10px 12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700;">Takt</div>
            <div>@Details.TaktSec сек/шт</div>
        </div>
        <div style="padding:10px 12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700;">Plan/hour</div>
            <div>@Details.PlanPerHour</div>
        </div>
    </div>

    <div style="margin-bottom:12px; padding:10px 12px; border:1px solid #ddd; border-radius:8px;">
        <span style="font-weight:700;">Итог:</span>
        <span style="margin-left:10px;">Plan: @Details.Totals.PlanShift</span>
        <span style="margin-left:10px;">Actual: @Details.Totals.ActualShift</span>
        <span style="margin-left:10px;">Dev: @Details.Totals.CumDeviation</span>
    </div>

    <HourlyInputTable Details="Details" OnSaved="Reload" />

    <div style="margin-top:14px;">
        <a href="/production-days">Назад к списку</a>
    </div>
}

@code {
    [Parameter] public Guid Id { get; set; }

    private ProductionDayDetailsDto? Details { get; set; }
    private string? Error { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        await Reload();
    }

    private void GoLogin()
    {
        Nav.NavigateTo("/auth/user");
    }

    private async Task Reload()
    {
        Error = null;

        try
        {
            Details = await ProductionDays.GetDetailsAsync(Id);
            if (Details == null)
                Error = "Смена не найдена.";
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }

        StateHasChanged();
    }
}