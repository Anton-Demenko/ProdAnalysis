@page "/admin/products"

@using ProdAnalysis.Application.Dtos.Admin
@using ProdAnalysis.Application.Services.Interfaces
@using ProdAnalysis.Domain.Enums
@using ProdAnalysis.Web.Services

@inject IProductAdminService AdminProducts
@inject CurrentUserService CurrentUser
@inject NavigationManager Nav

<h3>Products</h3>

@if (!CurrentUser.IsSet)
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        Выбери пользователя.
        <button type="button" style="margin-left:10px; padding:6px 10px; border:1px solid #333; border-radius:6px; background:#fff;" @onclick="GoLogin">Перейти</button>
    </div>
}
else if (CurrentUser.Role != UserRole.Admin)
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        Доступ запрещён.
    </div>
}
else
{
    @if (!string.IsNullOrWhiteSpace(Error))
    {
        <div style="padding:10px; border:1px solid #c33; border-radius:8px; margin-bottom:12px;">
            @Error
        </div>
    }

    <div style="display:flex; flex-direction:column; gap:12px; max-width:920px;">
        <div style="padding:12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700; margin-bottom:8px;">Добавить</div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <input type="text" placeholder="Name" @bind="NewName"
                       style="min-width:320px; padding:8px 10px; border:1px solid #aaa; border-radius:8px;" />

                <input type="text" placeholder="Code" @bind="NewCode"
                       style="min-width:180px; padding:8px 10px; border:1px solid #aaa; border-radius:8px;" />

                <button type="button" @onclick="Create"
                        disabled="@(IsBusy ? "disabled" : null)"
                        style="padding:8px 12px; border:1px solid #333; border-radius:8px; background:#fff;">
                    Add
                </button>

                <button type="button" @onclick="Reload"
                        disabled="@(IsBusy ? "disabled" : null)"
                        style="padding:8px 12px; border:1px solid #aaa; border-radius:8px; background:#fff;">
                    Refresh
                </button>
            </div>
        </div>

        <div style="overflow:auto; border:1px solid #ddd; border-radius:8px;">
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="background:#f6f6f6;">
                        <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Name</th>
                        <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Code</th>
                        <th style="text-align:center; padding:10px; border-bottom:1px solid #ddd;">Active</th>
                        <th style="padding:10px; border-bottom:1px solid #ddd;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var it in Items)
                    {
                        var isEditing = EditingId.HasValue && EditingId.Value == it.Id;
                        var rowStyle = it.IsActive ? "" : "color:#777;";

                        <tr style="@rowStyle">
                            <td style="padding:10px; border-bottom:1px solid #eee;">
                                @if (isEditing)
                                {
                                    <input type="text" @bind="EditName"
                                           style="min-width:320px; padding:6px 8px; border:1px solid #aaa; border-radius:6px;" />
                                }
                                else
                                {
                                    @it.Name
                                }
                            </td>

                            <td style="padding:10px; border-bottom:1px solid #eee;">
                                @if (isEditing)
                                {
                                    <input type="text" @bind="EditCode"
                                           style="min-width:180px; padding:6px 8px; border:1px solid #aaa; border-radius:6px;" />
                                }
                                else
                                {
                                    @it.Code
                                }
                            </td>

                            <td style="padding:10px; border-bottom:1px solid #eee; text-align:center;">
                                @(it.IsActive ? "Yes" : "No")
                            </td>

                            <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">
                                @if (isEditing)
                                {
                                    <button type="button" @onclick="SaveEdit"
                                            disabled="@(IsBusy ? "disabled" : null)"
                                            style="padding:6px 10px; border:1px solid #333; border-radius:8px; background:#fff;">
                                        Save
                                    </button>

                                    <button type="button" @onclick="CancelEdit"
                                            disabled="@(IsBusy ? "disabled" : null)"
                                            style="padding:6px 10px; border:1px solid #aaa; border-radius:8px; background:#fff; margin-left:8px;">
                                        Cancel
                                    </button>
                                }
                                else
                                {
                                    <button type="button" @onclick="(() => StartEdit(it))"
                                            disabled="@(IsBusy ? "disabled" : null)"
                                            style="padding:6px 10px; border:1px solid #333; border-radius:8px; background:#fff;">
                                        Edit
                                    </button>

                                    @if (it.IsActive)
                                    {
                                        <button type="button" @onclick="(() => SetActive(it.Id, false))"
                                                disabled="@(IsBusy ? "disabled" : null)"
                                                style="padding:6px 10px; border:1px solid #b00; border-radius:8px; background:#fff; margin-left:8px;">
                                            Deactivate
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="button" @onclick="(() => SetActive(it.Id, true))"
                                                disabled="@(IsBusy ? "disabled" : null)"
                                                style="padding:6px 10px; border:1px solid #333; border-radius:8px; background:#fff; margin-left:8px;">
                                            Activate
                                        </button>
                                    }
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div style="color:#666;">
            Deactivate скрывает Product из выбора в сменах, но не ломает историю.
        </div>
    </div>
}

@code {
    private List<ProductAdminDto> Items { get; set; } = new();
    private string? Error { get; set; }
    private bool IsBusy { get; set; }

    private string? NewName { get; set; }
    private string? NewCode { get; set; }

    private Guid? EditingId { get; set; }
    private string? EditName { get; set; }
    private string? EditCode { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private void GoLogin()
    {
        var rel = Nav.ToBaseRelativePath(Nav.Uri);
        var target = string.IsNullOrWhiteSpace(rel) ? "/" : "/" + rel;
        Nav.NavigateTo($"/auth/user?returnUrl={Uri.EscapeDataString(target)}");
    }

    private void Reload()
    {
        _ = LoadAsync();
    }

    private async Task LoadAsync()
    {
        Error = null;
        IsBusy = true;

        try
        {
            Items = (await AdminProducts.ListAsync()).ToList();
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsBusy = false;
        }

        StateHasChanged();
    }

    private async Task Create()
    {
        Error = null;

        var name = (NewName ?? "").Trim();
        var code = (NewCode ?? "").Trim();

        if (string.IsNullOrWhiteSpace(name))
        {
            Error = "Name is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(code))
        {
            Error = "Code is required.";
            return;
        }

        IsBusy = true;

        try
        {
            await AdminProducts.CreateAsync(name, code);
            NewName = null;
            NewCode = null;
            await LoadAsync();
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsBusy = false;
        }

        StateHasChanged();
    }

    private void StartEdit(ProductAdminDto it)
    {
        Error = null;
        EditingId = it.Id;
        EditName = it.Name;
        EditCode = it.Code;
    }

    private void CancelEdit()
    {
        EditingId = null;
        EditName = null;
        EditCode = null;
    }

    private async Task SaveEdit()
    {
        Error = null;

        if (!EditingId.HasValue)
            return;

        var name = (EditName ?? "").Trim();
        var code = (EditCode ?? "").Trim();

        if (string.IsNullOrWhiteSpace(name))
        {
            Error = "Name is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(code))
        {
            Error = "Code is required.";
            return;
        }

        IsBusy = true;

        try
        {
            await AdminProducts.UpdateAsync(EditingId.Value, name, code);
            EditingId = null;
            EditName = null;
            EditCode = null;
            await LoadAsync();
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsBusy = false;
        }

        StateHasChanged();
    }

    private async Task SetActive(Guid id, bool isActive)
    {
        Error = null;
        IsBusy = true;

        try
        {
            await AdminProducts.SetActiveAsync(id, isActive);
            await LoadAsync();
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsBusy = false;
        }

        StateHasChanged();
    }
}
