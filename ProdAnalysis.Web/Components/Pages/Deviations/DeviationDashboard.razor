@page "/deviations"
@implements IDisposable

@using System.Threading
@using ProdAnalysis.Application.Dtos.Deviations
@using ProdAnalysis.Application.Services.Interfaces
@using ProdAnalysis.Application.Dtos.Lookups
@using ProdAnalysis.Web.Services
@using ProdAnalysis.Domain.Enums

@inject IDeviationEventService Deviations
@inject ILookupService Lookups
@inject CurrentUserService CurrentUser
@inject NavigationManager Nav
@inject IConfiguration Configuration

<h3>Дашборд отклонений</h3>

@if (!CurrentUser.IsSet)
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        Сначала выбери пользователя.
        <button type="button" style="margin-left:10px; padding:6px 10px; border:1px solid #333; border-radius:6px; background:#fff;" @onclick="GoLogin">Перейти</button>
    </div>
}
else if (CurrentUser.Role != UserRole.Master && CurrentUser.Role != UserRole.Manager && CurrentUser.Role != UserRole.Admin)
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        Доступ запрещён.
    </div>
}
else
{
    <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:end; margin-bottom:14px;">
        <div style="display:flex; flex-direction:column; gap:6px;">
            <label>Дата</label>
            <InputDate TValue="DateTime ?" @bind-Value="DateValue" @bind-Value:after="OnFiltersChanged"
                       style="padding:6px 8px; border:1px solid #aaa; border-radius:6px;" disabled="@AllDates" />
        </div>

        <div style="display:flex; align-items:center; gap:8px; padding-bottom:4px;">
            <input type="checkbox" @bind="AllDates" @bind:after="OnFiltersChanged" />
            <label style="margin:0;">Все даты</label>
        </div>

        <div style="display:flex; flex-direction:column; gap:6px;">
            <label>WorkCenter</label>
            <select @bind="WorkCenterIdText" @bind:after="OnFiltersChanged"
                    style="padding:6px 8px; border:1px solid #aaa; border-radius:6px; min-width:220px;">
                <option value="">Все</option>
                @foreach (var wc in WorkCenters)
                {
                    <option value="@wc.Id">@wc.Name</option>
                }
            </select>
        </div>

        <div style="display:flex; align-items:center; gap:8px; padding-bottom:4px;">
            <input type="checkbox" @bind="IncludeClosed" @bind:after="OnFiltersChanged" />
            <label style="margin:0;">Показывать закрытые</label>
        </div>

        <button type="button" @onclick="Load" style="padding:7px 12px; border:1px solid #333; border-radius:8px; background:#fff;">
            Обновить
        </button>

        <div style="display:flex; align-items:center; gap:8px; padding-bottom:4px; margin-left:auto;">
            <input type="checkbox" @bind="AutoRefresh" @bind:after="OnAutoRefreshSettingsChanged" />
            <label style="margin:0;">Автообновление</label>
        </div>

        <div style="display:flex; flex-direction:column; gap:6px;">
            <label>Интервал, сек</label>
            <input type="number" min="2" max="300" step="1" @bind="AutoRefreshSeconds" @bind:after="OnAutoRefreshSettingsChanged"
                   style="padding:6px 8px; border:1px solid #aaa; border-radius:6px; width:120px;" />
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Error))
    {
        <div style="padding:10px; border:1px solid #c33; border-radius:8px; margin-bottom:12px;">
            @Error
        </div>
    }

    @if (Items.Count == 0)
    {
        <div>Отклонений нет.</div>
    }
    else
    {
        <div style="overflow:auto; border:1px solid #ddd; border-radius:8px;">
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="background:#f6f6f6;">
                        <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Когда</th>
                        <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">WorkCenter</th>
                        <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Product</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid #ddd;">Plan</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid #ddd;">Actual</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid #ddd;">Dev</th>
                        <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Статус</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid #ddd;">Возраст, мин</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid #ddd;">До L2</th>
                        <th style="text-align:right; padding:10px; border-bottom:1px solid #ddd;">Уровень</th>
                        <th style="padding:10px; border-bottom:1px solid #ddd;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var it in Items)
                    {
                        var isClosed = it.Status == DeviationEventStatus.Closed;
                        var rowStyle = it.Status == DeviationEventStatus.Open && it.CurrentEscalationLevel >= 2 ? "background:#fff3cd;" : "";
                        if (isClosed)
                            rowStyle = string.IsNullOrWhiteSpace(rowStyle) ? "color:#777;" : rowStyle + " color:#777;";

                        var devStyle = it.DeviationQty < 0 ? "color:#b00; font-weight:700;" : "";
                        var toL2Text = GetToL2Text(it);

                        <tr style="@rowStyle">
                            <td style="padding:10px; border-bottom:1px solid #eee;">
                                @it.ProductionDate.ToString("yyyy-MM-dd") @it.HourStart.ToString("HH:mm")
                            </td>
                            <td style="padding:10px; border-bottom:1px solid #eee;">@it.WorkCenterName</td>
                            <td style="padding:10px; border-bottom:1px solid #eee;">@it.ProductName</td>
                            <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">@it.PlanQty</td>
                            <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">@it.ActualQty</td>
                            <td style="padding:10px; border-bottom:1px solid #eee; text-align:right; @devStyle">@it.DeviationQty</td>
                            <td style="padding:10px; border-bottom:1px solid #eee;">@it.Status</td>
                            <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">@it.AgeMinutes</td>
                            <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">@toL2Text</td>
                            <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">L@it.CurrentEscalationLevel</td>
                            <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">
                                <NavLink href="@($"/deviations/{it.Id}")" style="text-decoration:none;">Открыть</NavLink>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
}

@code {
    private List<WorkCenterDto> WorkCenters { get; set; } = new();
    private List<DeviationEventListItemDto> Items { get; set; } = new();
    private string? Error { get; set; }

    private DateTime? DateValue { get; set; } = DateTime.Today;
    private bool AllDates { get; set; }
    private string? WorkCenterIdText { get; set; }
    private bool IncludeClosed { get; set; }

    private bool AutoRefresh { get; set; }
    private int AutoRefreshSeconds { get; set; } = 10;

    private Timer? _timer;
    private int _tickInProgress;

    private int _escalationMinutes = 30;

    protected override async Task OnInitializedAsync()
    {
        _escalationMinutes = Configuration.GetValue<int?>("Deviations:EscalationMinutes") ?? 30;
        WorkCenters = (await Lookups.GetWorkCentersAsync()).ToList();
        await LoadAsync();
    }

    private void GoLogin()
    {
        var rel = Nav.ToBaseRelativePath(Nav.Uri);
        var target = string.IsNullOrWhiteSpace(rel) ? "/" : "/" + rel;
        Nav.NavigateTo($"/auth/user?returnUrl={Uri.EscapeDataString(target)}");
    }

    private void Load()
    {
        _ = LoadAsync();
    }

    private void OnFiltersChanged()
    {
        if (AutoRefresh)
            RestartTimer();
    }

    private void OnAutoRefreshSettingsChanged()
    {
        RestartTimer();
    }

    private void RestartTimer()
    {
        StopTimer();

        if (!AutoRefresh)
            return;

        var sec = AutoRefreshSeconds;
        if (sec < 2) sec = 2;
        if (sec > 300) sec = 300;
        AutoRefreshSeconds = sec;

        _timer = new Timer(_ =>
        {
            _ = InvokeAsync(async () =>
            {
                if (!AutoRefresh)
                    return;

                if (Interlocked.Exchange(ref _tickInProgress, 1) == 1)
                    return;

                try
                {
                    await LoadAsync();
                }
                finally
                {
                    Interlocked.Exchange(ref _tickInProgress, 0);
                }
            });
        }, null, TimeSpan.FromSeconds(sec), TimeSpan.FromSeconds(sec));
    }

    private void StopTimer()
    {
        var t = _timer;
        _timer = null;
        if (t != null)
            t.Dispose();
        Interlocked.Exchange(ref _tickInProgress, 0);
    }

    private static int Priority(DeviationEventListItemDto x)
    {
        if (x.Status == DeviationEventStatus.Closed)
            return 3;

        if (x.Status == DeviationEventStatus.Open && x.CurrentEscalationLevel >= 2)
            return 0;

        if (x.Status == DeviationEventStatus.Open)
            return 1;

        return 2;
    }

    private string GetToL2Text(DeviationEventListItemDto it)
    {
        if (it.Status == DeviationEventStatus.Closed)
            return "—";

        if (it.Status == DeviationEventStatus.Acknowledged)
            return "ACK";

        if (it.CurrentEscalationLevel >= 2)
            return "Escalated";

        if (it.Status != DeviationEventStatus.Open)
            return "—";

        var esc = _escalationMinutes;
        if (esc < 0) esc = 0;

        var remaining = esc - it.AgeMinutes;
        if (remaining <= 0)
            return "Soon";

        return $"{remaining} min";
    }

    private async Task LoadAsync()
    {
        Error = null;

        try
        {
            Guid? wcId = null;
            if (!string.IsNullOrWhiteSpace(WorkCenterIdText) && Guid.TryParse(WorkCenterIdText, out var wc))
                wcId = wc;

            DateOnly? dateOnly = null;
            if (!AllDates && DateValue.HasValue)
                dateOnly = DateOnly.FromDateTime(DateValue.Value);

            var list = (await Deviations.ListAsync(dateOnly, wcId, IncludeClosed)).ToList();

            Items = list
                .OrderBy(x => Priority(x))
                .ThenByDescending(x => x.AgeMinutes)
                .ThenByDescending(x => x.CreatedAt)
                .ToList();
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }

        StateHasChanged();
    }

    public void Dispose()
    {
        StopTimer();
    }
}
