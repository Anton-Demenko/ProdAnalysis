@page "/deviations/{Id:guid}"

@using System.Threading
@using ProdAnalysis.Application.Dtos.Deviations
@using ProdAnalysis.Application.Services.Interfaces
@using ProdAnalysis.Web.Services
@using ProdAnalysis.Domain.Enums

@inject IDeviationEventService Deviations
@inject CurrentUserService CurrentUser
@inject NavigationManager Nav
@inject IConfiguration Configuration

<h3>Deviation details</h3>

@if (!CurrentUser.IsSet)
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        Select user first.
        <button type="button" style="margin-left:10px; padding:6px 10px; border:1px solid #333; border-radius:6px; background:#fff;" @onclick="GoLogin">Go</button>
    </div>
}
else if (CurrentUser.Role != UserRole.Master && CurrentUser.Role != UserRole.Manager && CurrentUser.Role != UserRole.Admin)
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        Access denied.
    </div>
}
else if (IsLoading)
{
    <div>Loading...</div>
}
else if (!string.IsNullOrWhiteSpace(Error))
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        @Error
    </div>
}
else if (Details == null)
{
    <div>Not found.</div>
}
else
{
    var isClosed = Details.Status == DeviationEventStatus.Closed;
    var canAck = !Details.AcknowledgedAt.HasValue;
    var canClose = !isClosed;
    var canNotify = !isClosed;

    <div style="display:flex; flex-direction:column; gap:12px;">
        <div style="padding:12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700; margin-bottom:6px;">
                @Details.ProductionDate.ToString("yyyy-MM-dd") @Details.HourStart.ToString("HH:mm")
                — @Details.WorkCenterName — @Details.ProductName
            </div>

            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div><b>Plan:</b> @Details.PlanQty</div>
                <div><b>Actual:</b> @Details.ActualQty</div>
                <div><b>Deviation:</b> <span style="color:#b00; font-weight:700;">@Details.DeviationQty</span></div>
                <div><b>Status:</b> @Details.Status</div>
                <div><b>Level:</b> L@Details.CurrentEscalationLevel</div>
                <div><b>Age:</b> @_ageMinutes min</div>
                <div><b>To L2:</b> @ToL2Text</div>
            </div>

            <div style="margin-top:8px; color:#666;">
                Created: @Details.CreatedAt.ToString("u")
            </div>

            @if (Details.AcknowledgedAt.HasValue)
            {
                <div style="margin-top:4px; color:#666;">
                    ACK: @Details.AcknowledgedAt.Value.ToString("u") by @Details.AcknowledgedBy
                </div>
            }

            @if (Details.ClosedAt.HasValue)
            {
                <div style="margin-top:4px; color:#666;">
                    Closed: @Details.ClosedAt.Value.ToString("u") by @Details.ClosedBy
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(Details.Note))
            {
                <div style="margin-top:8px;">
                    <b>Note:</b> @Details.Note
                </div>
            }
        </div>

        <div style="padding:12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700; margin-bottom:8px;">Actions</div>

            @if (!string.IsNullOrWhiteSpace(ActionError))
            {
                <div style="padding:10px; border:1px solid #c33; border-radius:8px; margin-bottom:10px;">
                    @ActionError
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(NotifyError))
            {
                <div style="padding:10px; border:1px solid #c33; border-radius:8px; margin-bottom:10px;">
                    @NotifyError
                </div>
            }

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <button type="button" @onclick="Ack" disabled="@(canAck ? null : "disabled")"
                        style="padding:8px 12px; border:1px solid #333; border-radius:8px; background:#fff;">
                    ACK
                </button>

                <button type="button" @onclick="Close" disabled="@(canClose ? null : "disabled")"
                        style="padding:8px 12px; border:1px solid #333; border-radius:8px; background:#fff;">
                    Close
                </button>

                <input type="text" placeholder="Close note (optional)" @bind="CloseNote" style="min-width:260px; padding:8px 10px; border:1px solid #aaa; border-radius:8px;" />

                <button type="button" @onclick="SendNotification" disabled="@(canNotify ? null : "disabled")"
                        style="padding:8px 12px; border:1px solid #333; border-radius:8px; background:#fff;">
                    Send notification (mock)
                </button>

                <input type="text" placeholder="Notification note (optional)" @bind="NotifyNote" style="min-width:260px; padding:8px 10px; border:1px solid #aaa; border-radius:8px;" />

                <button type="button" @onclick="Back" style="padding:8px 12px; border:1px solid #aaa; border-radius:8px; background:#fff;">
                    Back
                </button>
            </div>

            <div style="margin-top:10px; color:#666;">
                Send notification (mock) не отправляет внешние сообщения — только пишет запись в Escalation log.
            </div>

            @if (isClosed && canAck)
            {
                <div style="margin-top:10px; color:#666;">
                    Событие уже закрыто, но ACK можно проставить для фиксации реакции/подтверждения.
                </div>
            }
        </div>

        <div style="padding:12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700; margin-bottom:8px;">Escalation log</div>

            @if (Details.Escalations.Count == 0)
            {
                <div>No logs.</div>
            }
            else
            {
                <div style="overflow:auto;">
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f6f6f6;">
                                <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Time</th>
                                <th style="text-align:right; padding:10px; border-bottom:1px solid #ddd;">Level</th>
                                <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var l in Details.Escalations)
                            {
                                <tr>
                                    <td style="padding:10px; border-bottom:1px solid #eee;">@l.CreatedAt.ToString("u")</td>
                                    <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">L@l.Level</td>
                                    <td style="padding:10px; border-bottom:1px solid #eee;">@l.Message</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public Guid Id { get; set; }

    private bool IsLoading { get; set; } = true;
    private string? Error { get; set; }

    private string? ActionError { get; set; }
    private string? CloseNote { get; set; }

    private string? NotifyError { get; set; }
    private string? NotifyNote { get; set; }

    private DeviationEventDetailsDto? Details { get; set; }

    private Timer? _timer;
    private int _tickInProgress;

    private int _ageMinutes;
    private string ToL2Text { get; set; } = "—";

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
        StartTimer();
    }

    private void GoLogin()
    {
        var rel = Nav.ToBaseRelativePath(Nav.Uri);
        var target = string.IsNullOrWhiteSpace(rel) ? "/" : "/" + rel;
        Nav.NavigateTo($"/auth/user?returnUrl={Uri.EscapeDataString(target)}");
    }

    private async Task LoadAsync()
    {
        Error = null;
        ActionError = null;
        NotifyError = null;
        IsLoading = true;

        try
        {
            Details = await Deviations.GetAsync(Id);
            UpdateTimers();
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void StartTimer()
    {
        StopTimer();

        _timer = new Timer(_ =>
        {
            _ = InvokeAsync(() =>
            {
                if (Interlocked.Exchange(ref _tickInProgress, 1) == 1)
                    return;

                try
                {
                    UpdateTimers();
                    StateHasChanged();
                }
                finally
                {
                    Interlocked.Exchange(ref _tickInProgress, 0);
                }
            });
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private void StopTimer()
    {
        var t = _timer;
        _timer = null;
        if (t != null)
            t.Dispose();

        Interlocked.Exchange(ref _tickInProgress, 0);
    }

    private void UpdateTimers()
    {
        if (Details == null)
            return;

        var now = DateTime.UtcNow;

        _ageMinutes = (int)Math.Max(0, Math.Floor((now - Details.CreatedAt).TotalMinutes));

        if (Details.Status == DeviationEventStatus.Closed)
        {
            ToL2Text = "—";
            return;
        }

        if (Details.AcknowledgedAt.HasValue)
        {
            ToL2Text = "ACK";
            return;
        }

        if (Details.CurrentEscalationLevel >= 2)
        {
            ToL2Text = "Escalated";
            return;
        }

        var escalationMinutes = Configuration.GetValue<int?>("Deviations:EscalationMinutes") ?? 30;
        var toL2 = escalationMinutes - _ageMinutes;

        if (toL2 <= 0)
            ToL2Text = "Soon";
        else
            ToL2Text = $"{toL2} min";
    }

    private async Task Ack()
    {
        ActionError = null;

        try
        {
            await Deviations.AckAsync(new AckDeviationRequestDto(Id), CurrentUser.UserId!.Value);
            await LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ActionError = ex.Message;
        }
    }

    private async Task Close()
    {
        ActionError = null;

        try
        {
            await Deviations.CloseAsync(new CloseDeviationRequestDto(Id, CloseNote), CurrentUser.UserId!.Value);
            await LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ActionError = ex.Message;
        }
    }

    private async Task SendNotification()
    {
        NotifyError = null;

        try
        {
            await Deviations.NotifyAsync(new NotifyDeviationRequestDto(Id, NotifyNote), CurrentUser.UserId!.Value);
            NotifyNote = null;
            await LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotifyError = ex.Message;
        }
    }

    private void Back()
    {
        Nav.NavigateTo("/deviations");
    }

    public void Dispose()
    {
        StopTimer();
    }
}
