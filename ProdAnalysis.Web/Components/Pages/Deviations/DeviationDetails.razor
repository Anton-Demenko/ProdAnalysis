@page "/deviations/{Id:guid}"

@using ProdAnalysis.Application.Dtos.Deviations
@using ProdAnalysis.Application.Services.Interfaces
@using ProdAnalysis.Web.Services
@using ProdAnalysis.Domain.Enums

@inject IDeviationEventService Deviations
@inject CurrentUserService CurrentUser
@inject NavigationManager Nav

<h3>Deviation details</h3>

@if (!CurrentUser.IsSet)
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        Select user first.
        <button type="button" style="margin-left:10px; padding:6px 10px; border:1px solid #333; border-radius:6px; background:#fff;" @onclick="GoLogin">Go</button>
    </div>
}
else if (CurrentUser.Role != UserRole.Master && CurrentUser.Role != UserRole.Manager && CurrentUser.Role != UserRole.Admin)
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        Access denied.
    </div>
}
else if (IsLoading)
{
    <div>Loading...</div>
}
else if (!string.IsNullOrWhiteSpace(Error))
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        @Error
    </div>
}
else if (Details == null)
{
    <div>Not found.</div>
}
else
{
    var isClosed = Details.Status == DeviationEventStatus.Closed;

    <div style="display:flex; flex-direction:column; gap:12px;">
        <div style="padding:12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700; margin-bottom:6px;">
                @Details.ProductionDate.ToString("yyyy-MM-dd") @Details.HourStart.ToString("HH:mm")
                — @Details.WorkCenterName — @Details.ProductName
            </div>

            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div><b>Plan:</b> @Details.PlanQty</div>
                <div><b>Actual:</b> @Details.ActualQty</div>
                <div><b>Deviation:</b> <span style="color:#b00; font-weight:700;">@Details.DeviationQty</span></div>
                <div><b>Status:</b> @Details.Status</div>
                <div><b>Level:</b> L@Details.CurrentEscalationLevel</div>
            </div>

            <div style="margin-top:8px; color:#666;">
                Created: @Details.CreatedAt.ToString("u")
            </div>

            @if (Details.AcknowledgedAt.HasValue)
            {
                <div style="margin-top:4px; color:#666;">
                    ACK: @Details.AcknowledgedAt.Value.ToString("u") by @Details.AcknowledgedBy
                </div>
            }

            @if (Details.ClosedAt.HasValue)
            {
                <div style="margin-top:4px; color:#666;">
                    Closed: @Details.ClosedAt.Value.ToString("u") by @Details.ClosedBy
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(Details.Note))
            {
                <div style="margin-top:8px;">
                    <b>Note:</b> @Details.Note
                </div>
            }
        </div>

        <div style="padding:12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700; margin-bottom:8px;">Actions</div>

            @if (!string.IsNullOrWhiteSpace(ActionError))
            {
                <div style="padding:10px; border:1px solid #c33; border-radius:8px; margin-bottom:10px;">
                    @ActionError
                </div>
            }

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <button type="button" @onclick="Ack" disabled="@isClosed" style="padding:8px 12px; border:1px solid #333; border-radius:8px; background:#fff;">
                    ACK
                </button>

                <button type="button" @onclick="Close" disabled="@isClosed" style="padding:8px 12px; border:1px solid #333; border-radius:8px; background:#fff;">
                    Close
                </button>

                <input type="text" placeholder="Close note (optional)" @bind="CloseNote" style="min-width:260px; padding:8px 10px; border:1px solid #aaa; border-radius:8px;" />

                <button type="button" @onclick="Back" style="padding:8px 12px; border:1px solid #aaa; border-radius:8px; background:#fff;">
                    Back
                </button>
            </div>
        </div>

        <div style="padding:12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700; margin-bottom:8px;">Escalation log</div>

            @if (Details.Escalations.Count == 0)
            {
                <div>No logs.</div>
            }
            else
            {
                <div style="overflow:auto;">
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f6f6f6;">
                                <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Time</th>
                                <th style="text-align:right; padding:10px; border-bottom:1px solid #ddd;">Level</th>
                                <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var l in Details.Escalations)
                            {
                                <tr>
                                    <td style="padding:10px; border-bottom:1px solid #eee;">@l.CreatedAt.ToString("u")</td>
                                    <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">L@l.Level</td>
                                    <td style="padding:10px; border-bottom:1px solid #eee;">@l.Message</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public Guid Id { get; set; }

    private bool IsLoading { get; set; } = true;
    private string? Error { get; set; }

    private string? ActionError { get; set; }
    private string? CloseNote { get; set; }

    private DeviationEventDetailsDto? Details { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
    }

    private void GoLogin()
    {
        var rel = Nav.ToBaseRelativePath(Nav.Uri);
        var target = string.IsNullOrWhiteSpace(rel) ? "/" : "/" + rel;
        Nav.NavigateTo($"/auth/user?returnUrl={Uri.EscapeDataString(target)}");
    }

    private async Task LoadAsync()
    {
        Error = null;
        ActionError = null;
        IsLoading = true;

        try
        {
            Details = await Deviations.GetAsync(Id);
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task Ack()
    {
        ActionError = null;

        try
        {
            await Deviations.AckAsync(new AckDeviationRequestDto(Id), CurrentUser.UserId!.Value);
            await LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ActionError = ex.Message;
        }
    }

    private async Task Close()
    {
        ActionError = null;

        try
        {
            await Deviations.CloseAsync(new CloseDeviationRequestDto(Id, CloseNote), CurrentUser.UserId!.Value);
            await LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ActionError = ex.Message;
        }
    }

    private void Back()
    {
        Nav.NavigateTo("/deviations");
    }
}