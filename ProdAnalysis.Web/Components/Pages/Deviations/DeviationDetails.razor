@page "/deviations/{Id:guid}"
@implements IDisposable

@using System.Threading
@using Microsoft.Extensions.Options
@using ProdAnalysis.Application.Options
@using ProdAnalysis.Application.Dtos.Deviations
@using ProdAnalysis.Application.Services.Interfaces
@using ProdAnalysis.Web.Services
@using ProdAnalysis.Domain.Enums

@inject IDeviationEventService Deviations
@inject IOptions<DeviationOptions> DeviationOptions
@inject CurrentUserService CurrentUser
@inject NavigationManager Nav

<h3>Детали отклонения</h3>

@if (!CurrentUser.IsSet)
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        Сначала выбери пользователя.
        <button type="button" style="margin-left:10px; padding:6px 10px; border:1px solid #333; border-radius:6px; background:#fff;" @onclick="GoLogin">Перейти</button>
    </div>
}
else if (CurrentUser.Role != UserRole.Master && CurrentUser.Role != UserRole.Manager && CurrentUser.Role != UserRole.Admin)
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        Доступ запрещён.
    </div>
}
else if (IsLoading)
{
    <div>Загрузка...</div>
}
else if (!string.IsNullOrWhiteSpace(Error))
{
    <div style="padding:10px; border:1px solid #c33; border-radius:8px;">
        @Error
    </div>
}
else if (Details == null)
{
    <div>Не найдено.</div>
}
else
{
    var isClosed = Details.Status == DeviationEventStatus.Closed;
    var canAck = !Details.AcknowledgedAt.HasValue;
    var canClose = !isClosed;

    <div style="display:flex; flex-direction:column; gap:12px;">
        <div style="padding:12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700; margin-bottom:6px;">
                @Details.ProductionDate.ToString("yyyy-MM-dd") @Details.HourStart.ToString("HH:mm")
                — @Details.WorkCenterName — @Details.ProductName
            </div>

            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div><b>Plan:</b> @Details.PlanQty</div>
                <div><b>Actual:</b> @Details.ActualQty</div>
                <div><b>Deviation:</b> <span style="color:#b00; font-weight:700;">@Details.DeviationQty</span></div>
                <div><b>Status:</b> @Details.Status</div>
                <div><b>Level:</b> L@Details.CurrentEscalationLevel</div>
            </div>

            <div style="margin-top:10px; display:flex; gap:18px; flex-wrap:wrap; align-items:center;">
                <div><b>Возраст:</b> @AgeText</div>
                <div><b>До L2:</b> <span style="@ToL2Style">@ToL2Text</span></div>
                <div style="color:#666;">SLA: @EscalationMinutes мин без ACK</div>
            </div>

            <div style="margin-top:8px; color:#666;">
                Created: @Details.CreatedAt.ToString("u")
            </div>

            @if (Details.AcknowledgedAt.HasValue)
            {
                <div style="margin-top:4px; color:#666;">
                    ACK: @Details.AcknowledgedAt.Value.ToString("u") by @Details.AcknowledgedBy
                </div>
            }

            @if (Details.ClosedAt.HasValue)
            {
                <div style="margin-top:4px; color:#666;">
                    Closed: @Details.ClosedAt.Value.ToString("u") by @Details.ClosedBy
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(Details.Note))
            {
                <div style="margin-top:8px;">
                    <b>Note:</b> @Details.Note
                </div>
            }
        </div>

        <div style="padding:12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700; margin-bottom:8px;">Действия</div>

            @if (!string.IsNullOrWhiteSpace(ActionError))
            {
                <div style="padding:10px; border:1px solid #c33; border-radius:8px; margin-bottom:10px;">
                    @ActionError
                </div>
            }

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <button type="button" @onclick="Ack" disabled="@(!canAck)"
                        style="padding:8px 12px; border:1px solid #333; border-radius:8px; background:#fff;">
                    ACK
                </button>

                <button type="button" @onclick="Close" disabled="@(!canClose)"
                        style="padding:8px 12px; border:1px solid #333; border-radius:8px; background:#fff;">
                    Close
                </button>

                <input type="text" placeholder="Close note (optional)" @bind="CloseNote" style="min-width:260px; padding:8px 10px; border:1px solid #aaa; border-radius:8px;" />

                <button type="button" @onclick="Back" style="padding:8px 12px; border:1px solid #aaa; border-radius:8px; background:#fff;">
                    Назад
                </button>
            </div>

            @if (isClosed && canAck)
            {
                <div style="margin-top:10px; color:#666;">
                    Событие уже закрыто, но ACK можно проставить для фиксации реакции/подтверждения.
                </div>
            }
        </div>

        <div style="padding:12px; border:1px solid #ddd; border-radius:8px;">
            <div style="font-weight:700; margin-bottom:8px;">Escalation log</div>

            @if (Details.Escalations.Count == 0)
            {
                <div>No logs.</div>
            }
            else
            {
                <div style="overflow:auto;">
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f6f6f6;">
                                <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Time</th>
                                <th style="text-align:right; padding:10px; border-bottom:1px solid #ddd;">Level</th>
                                <th style="text-align:left; padding:10px; border-bottom:1px solid #ddd;">Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var l in Details.Escalations)
                            {
                                <tr>
                                    <td style="padding:10px; border-bottom:1px solid #eee;">@l.CreatedAt.ToString("u")</td>
                                    <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">L@l.Level</td>
                                    <td style="padding:10px; border-bottom:1px solid #eee;">@l.Message</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public Guid Id { get; set; }

    private bool IsLoading { get; set; } = true;
    private string? Error { get; set; }

    private string? ActionError { get; set; }
    private string? CloseNote { get; set; }

    private DeviationEventDetailsDto? Details { get; set; }

    private Timer? _uiTimer;
    private int _uiTickInProgress;

    private int EscalationMinutes
    {
        get
        {
            var v = DeviationOptions.Value.EscalationMinutes;
            if (v < 1) v = 1;
            if (v > 24 * 60) v = 24 * 60;
            return v;
        }
    }

    private string AgeText
    {
        get
        {
            if (Details == null)
                return "—";

            var min = (int)Math.Floor((DateTime.UtcNow - Details.CreatedAt).TotalMinutes);
            if (min < 0) min = 0;
            return $"{min} мин";
        }
    }

    private string ToL2Text
    {
        get
        {
            if (Details == null)
                return "—";

            if (Details.Status == DeviationEventStatus.Closed)
                return "—";

            if (Details.CurrentEscalationLevel >= 2)
                return "Эскалировано";

            if (Details.Status == DeviationEventStatus.Acknowledged)
                return "ACK";

            var min = (int)Math.Floor((DateTime.UtcNow - Details.CreatedAt).TotalMinutes);
            if (min < 0) min = 0;

            var rem = EscalationMinutes - min;
            if (rem <= 0)
                return "Сейчас";

            return $"{rem} мин";
        }
    }

    private string ToL2Style
    {
        get
        {
            if (Details == null)
                return "";

            if (Details.Status == DeviationEventStatus.Closed)
                return "";

            if (Details.CurrentEscalationLevel >= 2)
                return "font-weight:700;";

            if (Details.Status == DeviationEventStatus.Acknowledged)
                return "";

            var min = (int)Math.Floor((DateTime.UtcNow - Details.CreatedAt).TotalMinutes);
            if (min < 0) min = 0;

            var rem = EscalationMinutes - min;
            if (rem <= 0)
                return "color:#b00; font-weight:700;";

            if (rem <= 5)
                return "color:#b00; font-weight:700;";

            return "";
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
        StartUiTimer();
    }

    private void StartUiTimer()
    {
        StopUiTimer();

        _uiTimer = new Timer(_ =>
        {
            _ = InvokeAsync(() =>
            {
                if (Interlocked.Exchange(ref _uiTickInProgress, 1) == 1)
                    return;

                try
                {
                    StateHasChanged();
                }
                finally
                {
                    Interlocked.Exchange(ref _uiTickInProgress, 0);
                }
            });
        }, null, TimeSpan.FromSeconds(10), TimeSpan.FromSeconds(10));
    }

    private void StopUiTimer()
    {
        var t = _uiTimer;
        _uiTimer = null;
        if (t != null)
            t.Dispose();
        Interlocked.Exchange(ref _uiTickInProgress, 0);
    }

    private void GoLogin()
    {
        var rel = Nav.ToBaseRelativePath(Nav.Uri);
        var target = string.IsNullOrWhiteSpace(rel) ? "/" : "/" + rel;
        Nav.NavigateTo($"/auth/user?returnUrl={Uri.EscapeDataString(target)}");
    }

    private async Task LoadAsync()
    {
        Error = null;
        ActionError = null;
        IsLoading = true;

        try
        {
            Details = await Deviations.GetAsync(Id);
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task Ack()
    {
        ActionError = null;

        try
        {
            await Deviations.AckAsync(new AckDeviationRequestDto(Id), CurrentUser.UserId!.Value);
            await LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ActionError = ex.Message;
        }
    }

    private async Task Close()
    {
        ActionError = null;

        try
        {
            await Deviations.CloseAsync(new CloseDeviationRequestDto(Id, CloseNote), CurrentUser.UserId!.Value);
            await LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ActionError = ex.Message;
        }
    }

    private void Back()
    {
        Nav.NavigateTo("/deviations");
    }

    public void Dispose()
    {
        StopUiTimer();
    }
}
